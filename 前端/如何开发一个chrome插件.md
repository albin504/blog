
# 我开发的插件效果
为公司业务的后台系统开发了chrome插件，它的功能如下：

## 1、在每个后台页面展示pv、uv，便于产品经理和开发人员直观了解功能上线后的使用情况。

<img width="547" alt="image" src="https://user-images.githubusercontent.com/3232275/221410441-f6ddaa15-faa3-4528-aec2-9a427ef4d0d5.png">

## 2、开发了一些系统增强功能，如便捷切换用户帐号。
<img width="457" alt="image" src="https://user-images.githubusercontent.com/3232275/221410574-53d002cc-21f3-449e-9a65-5ddddce0a346.png">

我们的产品经理和开发人员，在排查用户反馈的问题时，经常需要模拟登录用户帐号，这里提供了便捷切换帐号的功能，它有以下特点：
1. 可自动感知用户当前访问的环境（测试环境、生产环境、沙盒环境等）。举例，用户访问的是测试环境，那么就在测试环境进行帐号模拟登录
2. 记录帐号切换的历史记录，方便用户一键切换。

另外，插件还展示了一些系统功能的菜单、获取更丰富的用户信息。

# 相比网站中的js代码，chrome插件能提供哪些特有的功能？
1、可以获取chrome浏览器api，进而对浏览器功能进行加强。
举例：

- chrome api可以读取、修改浏览器的书签，基于此，开发者可以开发书签管理的插件。
- chrome api可以获取浏览器上活跃的标签信息（即当前打开的页面链接等信息），可以切换活跃的标签
- 可以自定义浏览器右键菜单
<img width="648" alt="image" src="https://user-images.githubusercontent.com/3232275/221411162-48494075-3d84-4676-a4c6-01e4d86f56b6.png">

。。。。。。


# 如何开发插件？

我理解chrome插件，主要提供了三类功能：

## 1、运行在网页上下文的Content scripts.

chrome插件，可以给特定的网站，附加一些js代码，并执行。
在我的插件中，可以给每个页面动态增加pv、uv，就是基于这个特性。

  https://developer.chrome.com/docs/extensions/mv3/content_scripts/

-----
  
**Content scripts运行在一个独立的执行环境中** 。

也就是说，chrome插件中定义的js代码，不会修改网站中js变量或者函数，它是独立运行的，因此非常安全。

我曾经在我们的网站中，写了一段公共的js代码，在每个页面中进行用户行为埋点上报。
```
  window.onload = function(){
    // ......
  }
```
记得大概是写了上面这样一段代码，运行之后，发现某些页面本身定义的onload函数无法执行了，问题就在于我修改了window.onload这个全局变量的值，导致业务出现问题。

那么，如果用chrome插件实现类似功能，因为是运行在独立的执行环境中，就不会出现这样的问题。

-----

**由于运行在独立的环境中，意味着插件和网页之间变量无法共享、函数也无法相互调用，那么，插件和网页之间如何进行通信呢？**

和“网页与iframe之间的通信”很类似，一方调用window.postMessage(), 另一方通过监听“message”事件获取消息。

  https://developer.chrome.com/docs/extensions/mv3/messaging/


## 2、插件面板的开发。
在我们用的很多chrome插件中，点击插件图标，都会出现一个小面板。可以基于chrome插件的Extension HTML pages功能，开发这个小面板。

代码写法就和写网页的html、js一样。另外，它的特点如下：

1、 在面板中进行的网络请求（如ajax），默认会带上同域名下的cookie。

举例，在面板中请求了www.baidu.com的接口，浏览器上如果已经存储了该域名下的cookie，这些cookie待会带上去。

2、在面板中，可以获取浏览器当前打开的页面的链接。

我的插件中有个效果是，能自动判断当前的网站环境（测试环境、生产环境），其实就是利用了这里的功能，获取到了活跃的标签的信息。

3、可以调用chrome api。插件提供的所有功能，都可以调用chrome api，但是允许调用的api有差异。

## 3、service worker

在chrome插件中可以开发了一个backgroup.js，类似于一个后台线程，它可以监控浏览器的事件，如修改书签事件、切换标签事件等。

# 扩展知识
我开发的插件中，“帐号切换的历史记录” 功能，利用了浏览器提供的IndexDB功能，它是浏览器提供的事务性数据库。

localStorage能做的事情IndexDB都能做。同时，IndexDB又提供了关系型数据库提供的便捷的增删改查、索引、事务功能。

对于在浏览器端管理复杂的数据结构，IndexDB功能是很强大的。

--- 

另外，chrome插件的用户隐私管理，也是很重要的一个课题。


